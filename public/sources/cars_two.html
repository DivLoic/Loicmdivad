<style>
  div[class^='tooltip'], p{
    display: inline-block;
    vertical-align: top;
    margin-bottom: 0;

  }
  div[class^='tooltip']{
    height: 20px;
    width: 20px;
    border-radius: 100%;
    margin-right: 10px;
    margin-top: 5px;
  }
  .tooltip0{ background-color: rgb(198,219,239);  }
  .tooltip1{ background-color: rgb(158,202,225);  }
  .tooltip2{ background-color: rgb(107,174,214);  }
  .tooltip3{ background-color: rgb(66,146,198);   }
  .tooltip4{ background-color: rgb(33,113,181);   }
  .tooltip5{ background-color: rgb(8,81,156);     }
  .tooltip6{ background-color: rgb(4,57,111);     }
  .tooltip7{ background-color: rgb(8,48,107);     }
</style>
<!-- <script src="//d3js.org/topojson.v1.min.js"></script> -->
<!-- see :
http://www.apur.org/open_data/ARRONDISSEMENT_OD.zip
-->
<!-- see :
https://bost.ocks.org/mike/map/
-->
<div>
    <div id="map"></div>
    <div style="margin: auto; color:#777777; text-align: center;">
      - Number of accidents per rings or arrondissements of paris <br/>
      between 2012 / 2013 -
    </div> <br/>
    <div class="row">
      <div class="six columns">
        <div class="ledgend"><div class="tooltip0"></div><p>Less than 400</p></div>
        <div class="ledgend"><div class="tooltip1"></div><p>Between 400-600</p></div>
        <div class="ledgend"><div class="tooltip2"></div><p>Between 600-800</p></div>
        <div class="ledgend"><div class="tooltip3"></div><p>Between 800-1000</p></div>
      </div>
      <div class="six columns">
        <div class="ledgend"><div class="tooltip4"></div><p>Between 1000-1200</p></div>
        <div class="ledgend"><div class="tooltip5"></div><p>Between 1200-1400</p></div>
        <div class="ledgend"><div class="tooltip6"></div><p>Between 1400-1600</p></div>
        <div class="ledgend"><div class="tooltip7"></div><p>More than 1600</p></div>
      </div>
    </div>
    <br/>
    <div class="row">
      <p>
        This school project propose to study a dataset of car accidents around Paris.
        The <em>.csv</em> file with all the records can be download from
        <a href="http://opendata.paris.fr/explore/?q=accidentologie">opendata.paris.fr</a>.
        Once the file have been load into the Hadoop filesystem we are able to run un really simple Map/Reduce job
        with Python and Spark, then save the result as json. Here the Python code:
      <p>
    <div>
    <pre><code class="python">from pyspark.sql import Row
from pyspark.sql import DataFrame

rdd = sc.textFile('/home/loicmdivad/accidents.csv')
count = rdd.map(lambda line: line.split(";")) \
.filter(lambda y: y[0] == TARGET_YEAR) \
.map(lambda y: (y[3] , 1)) \
.reduceByKey(lambda a, b: a + b) \
.sortBy(lambda y: y[1])

Rings = Row("code", "crash")
table = count.map(lambda y: Rings(y[0], y[1]))
count.toDF().toJSON() # {"code": 01, "crash": 321}, ...
# here the action triggers all previous transformations
      </code></pre>
    <div class="row">
      <p>
        Here we can conclude a simple thing. The first rings (01, 02 etc...) are inside the city.
        So there are less car then places at the edge, crossed by the highway
        (<a href="https://en.wikipedia.org/wiki/Boulevard_Périphérique"> Bld Périphérique</a>).
        Once the json is ready a simple plot can be done with D3.js. This is a piece of
        javascript code:
      <p>
    </div>
    <pre><code class="javascript">Ember.$.get("/datastore/parisRings.json", function(doc) {
  group.append('path')
  .attr('d', path)
  .attr('class','stroke')
  .attr('fill', function(d){
    return mapColor(doc, d.properties.CODE_COMM, 200)
   })
  .style('stroke', 'white')
  .style("stroke-width", "1.5");
});
      </code></pre>
  </div>
</div>
<script>

  var bleu_gard = [
    d3.rgb(198,219,239),
    d3.rgb(158,202,225),
    d3.rgb(107,174,214),
    d3.rgb(66,146,198),
    d3.rgb(33,113,181),
    d3.rgb(8,81,156),
    d3.rgb(4,57,111),
    d3.rgb(8,48,107)
  ];

  var grad = {"sc0": d3.rgb(198,219,239),
    "sc1": d3.rgb(158,202,225),
    "sc2": d3.rgb(107,174,214),
    "sc3": d3.rgb(66,146,198),
    "sc4": d3.rgb(33,113,181),
    "sc5": d3.rgb(8,81,156),
    "sc6": d3.rgb(8,48,107),
    "sc7": d3.rgb(4,57,111)};

  var mapColor = function(tab,dept,scale){
    var n = tab.filter(function(element){
      return element["street"] == dept;
    });
    n = n[0]["number"];

    if(n < 300){
      return d3.rgb(198,219,239);
    }else if(n < 400){
      return d3.rgb(158,202,225);
    }else if(n < 600){
      return d3.rgb(107,174,214);
    }else if(n < 800){
      return d3.rgb(66,146,198);
    }else if(n < 1000){
      return d3.rgb(33,113,181);
    }else if(n < 1100){
      return d3.rgb(8,81,156);
    }else if(n < 1200){
      return d3.rgb(8,48,107);
    }else{
      return d3.rgb(4,57,111);
    }

    /*n = Math.floor(parseInt(n) / scale);
    key = 'sc' + String(n);
    return grad[key]*/
  };

  var threshold = 770;
  var windowsize = Ember.$(window).width();

  var width = 680;
  var height =  400;

  var scale = 150000;
  var tx = -5790;
  var ty = 147200;

  if (windowsize < threshold){
    width = width / 2;
    height =  height / 2;
    scale = scale  / 2;
    tx = tx / 2; ty = ty / 2;
  }

  var canvas = d3.select('div#map').append('svg')
    .attr('width', width)
    .attr('height', height);

  d3.json('/datastore/paris.json', function(data){
    var group = canvas.selectAll('g')
      .data(data.features)
      .enter()
      .append('g');

    var projection = d3.geo.mercator()
      .scale(scale)
      .translate([tx, ty]);

    var path = d3.geo.path().projection(projection);

    Ember.$.get("/datastore/parisRings.json", function(doc) {
      group.append('path')
        .attr('d', path)
        .attr('class','stroke')
        .attr('fill', '#ffffff')
        .transition().duration(4000)
        .attr('fill', function(d){return mapColor(doc, d.properties.CODE_COMM, 200)})
        .style('stroke', 'white')
        .style("stroke-width", "1.5");

      group.append('svg:text')
        .attr('x', function(d){ return path.centroid(d)[0]})
        .attr('y',function(d){return path.centroid(d)[1] + 10})
        .text(function(d){return d.properties.CODE_COMM.slice(-2);})
        .attr("font-family", "sans-serif")
        .attr("font-size", "11px")
        .style("fill",'white');
    });
  });
</script>
